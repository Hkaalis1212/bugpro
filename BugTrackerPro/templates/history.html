<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Report History - AI Bug Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hover-lift:hover { transform: translateY(-2px); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('index') }}" class="text-blue-400 hover:text-blue-300 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Reporter
                </a>
                <h1 class="text-xl font-bold">Bug Report History</h1>
            </div>
            {% if current_user.is_authenticated %}
            <div class="flex items-center space-x-4">
                <span class="text-gray-300">Welcome, {{ current_user.first_name }}</span>
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin_dashboard') }}" class="text-purple-400 hover:text-purple-300">
                    <i class="fas fa-cog mr-1"></i>Admin
                </a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="text-red-400 hover:text-red-300">
                    <i class="fas fa-sign-out-alt mr-1"></i>Logout
                </a>
            </div>
            {% endif %}
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-4">
                <i class="fas fa-history text-blue-400 mr-3"></i>
                Your Bug Reports
            </h1>
            <p class="text-gray-400 text-lg">Track the progress of your submitted bug reports</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="bg-gradient-to-br from-blue-800 to-blue-900 rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-blue-200" id="totalReports">0</div>
                <div class="text-blue-300 text-sm">Total Reports</div>
            </div>
            <div class="bg-gradient-to-br from-green-800 to-green-900 rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-green-200" id="resolvedReports">0</div>
                <div class="text-green-300 text-sm">Resolved</div>
            </div>
            <div class="bg-gradient-to-br from-yellow-800 to-yellow-900 rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-yellow-200" id="inProgressReports">0</div>
                <div class="text-yellow-300 text-sm">In Progress</div>
            </div>
            <div class="bg-gradient-to-br from-purple-800 to-purple-900 rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-purple-200" id="avgScore">0</div>
                <div class="text-purple-300 text-sm">Avg Score</div>
            </div>
        </div>

        <!-- Filter and Search -->
        <div class="bg-gray-800 rounded-xl p-6 mb-8 fade-in">
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1 relative">
                    <input type="text" id="searchInput" placeholder="Search by title, description, or ID..." 
                           class="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex gap-2">
                    <select id="statusFilter" class="px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                        <option value="">All Status</option>
                        <option value="open">ðŸ”µ Open</option>
                        <option value="in_progress">ðŸŸ¡ In Progress</option>
                        <option value="resolved">ðŸŸ¢ Resolved</option>
                        <option value="closed">âš« Closed</option>
                    </select>
                    <select id="priorityFilter" class="px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                        <option value="">All Priorities</option>
                        <option value="critical">ðŸ”´ Critical</option>
                        <option value="high">ðŸŸ  High</option>
                        <option value="medium">ðŸŸ¡ Medium</option>
                        <option value="low">ðŸŸ¢ Low</option>
                    </select>
                    <select id="sortFilter" class="px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                        <option value="date_desc">ðŸ“… Newest First</option>
                        <option value="date_asc">ðŸ“… Oldest First</option>
                        <option value="priority_desc">ðŸ”¥ High Priority First</option>
                        <option value="score_desc">ðŸ“Š Highest Score First</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Reports List -->
        <div id="reportsList" class="space-y-6">
            <!-- Reports will be loaded here dynamically -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mb-4"></div>
            <p class="text-gray-400">Loading your reports...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <i class="fas fa-inbox text-6xl text-gray-600 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-300 mb-2">No Bug Reports Yet</h3>
            <p class="text-gray-500 mb-6">You haven't submitted any bug reports. Start by reporting your first bug!</p>
            <a href="{{ url_for('index') }}" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Submit Your First Bug Report
            </a>
        </div>
    </div>

    <script>
        let allReports = [];
        let filteredReports = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadUserReports();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterReports);
            document.getElementById('statusFilter').addEventListener('change', filterReports);
            document.getElementById('priorityFilter').addEventListener('change', filterReports);
            document.getElementById('sortFilter').addEventListener('change', filterReports);
        }

        async function loadUserReports() {
            try {
                const response = await fetch('/api/user/reports');
                if (response.ok) {
                    allReports = await response.json();
                    filteredReports = [...allReports];
                    updateStats();
                    displayReports();
                } else {
                    showError('Failed to load reports');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                showError('Network error while loading reports');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function updateStats() {
            const total = allReports.length;
            const resolved = allReports.filter(r => r.status === 'resolved').length;
            const inProgress = allReports.filter(r => r.status === 'in_progress').length;
            const avgScore = total > 0 ? (allReports.reduce((sum, r) => sum + (r.reproducibility_score || 0), 0) / total).toFixed(1) : 0;

            document.getElementById('totalReports').textContent = total;
            document.getElementById('resolvedReports').textContent = resolved;
            document.getElementById('inProgressReports').textContent = inProgress;
            document.getElementById('avgScore').textContent = avgScore;
        }

        function displayReports() {
            const container = document.getElementById('reportsList');
            const emptyState = document.getElementById('emptyState');

            if (filteredReports.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            container.innerHTML = filteredReports.map(report => `
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 card-hover hover-lift fade-in report-card" data-report-id="${report.id}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h3 class="text-xl font-semibold text-white">${escapeHtml(report.title)}</h3>
                                <span class="text-xs text-gray-500 bg-gray-700 px-2 py-1 rounded">#${report.id}</span>
                            </div>
                            <p class="text-gray-400 text-sm mb-3">${truncateText(report.description, 150)}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span title="Created date"><i class="fas fa-calendar mr-1"></i>${formatDate(report.created_at)}</span>
                                ${report.reproducibility_score ? `<span title="AI Reproducibility Score"><i class="fas fa-chart-line mr-1"></i>Score: ${report.reproducibility_score.toFixed(1)}/100</span>` : ''}
                                ${report.assignedUser ? `<span title="Assigned to"><i class="fas fa-user mr-1"></i>${report.assignedUser}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            ${getStatusBadge(report.status)}
                            ${report.priority ? getPriorityBadge(report.priority) : ''}
                        </div>
                    </div>
                    
                    <!-- Expandable Content -->
                    <div class="report-details hidden">
                        ${report.parsed_steps ? `
                        <div class="bg-gray-900 rounded-lg p-4 mb-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2 flex items-center">
                                <i class="fas fa-robot mr-2 text-purple-400"></i>
                                AI-Generated Reproduction Steps
                                <span class="ml-2 text-xs text-purple-400 bg-purple-900 px-2 py-1 rounded">AI Explanation</span>
                            </h4>
                            <pre class="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed">${report.parsed_steps}</pre>
                        </div>
                        ` : ''}
                        
                        ${report.attachments && report.attachments.length > 0 ? `
                        <div class="bg-gray-900 rounded-lg p-4 mb-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">
                                <i class="fas fa-paperclip mr-2"></i>Attachments (${report.attachments.length})
                            </h4>
                            <div class="space-y-2">
                                ${report.attachments.map(att => `
                                    <div class="flex items-center space-x-2 text-sm">
                                        <i class="fas fa-file text-blue-400"></i>
                                        <span class="text-gray-300">${att.filename}</span>
                                        <span class="text-gray-500">(${(att.file_size / 1024).toFixed(1)} KB)</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex items-center justify-between pt-4 border-t border-gray-700">
                        <div class="flex items-center space-x-2">
                            ${report.reproducibility_confidence ? `
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getConfidenceBadgeClass(report.reproducibility_confidence)}" title="AI Confidence Level">
                                <i class="fas fa-shield-alt mr-1"></i>${report.reproducibility_confidence.toUpperCase()}
                            </span>
                            ` : ''}
                            ${report.github_issue_url ? `
                            <a href="${report.github_issue_url}" target="_blank" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-700 text-gray-300 hover:bg-gray-600" title="View GitHub Issue">
                                <i class="fab fa-github mr-1"></i>GitHub
                            </a>
                            ` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <a href="/bug/${report.id}" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors">
                                View Details <i class="fas fa-eye ml-1"></i>
                            </a>
                            <button onclick="toggleReportDetails(${report.id})" class="text-gray-400 hover:text-gray-300 text-sm font-medium transition-colors">
                                <span class="expand-text">Expand</span> <i class="fas fa-chevron-down ml-1 expand-icon transition-transform"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterReports() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            filteredReports = allReports.filter(report => {
                const matchesSearch = !searchTerm || 
                    report.title.toLowerCase().includes(searchTerm) || 
                    report.description.toLowerCase().includes(searchTerm) ||
                    report.id.toString().includes(searchTerm);
                const matchesStatus = !statusFilter || report.status === statusFilter;
                const matchesPriority = !priorityFilter || report.priority === priorityFilter;
                return matchesSearch && matchesStatus && matchesPriority;
            });

            // Apply sorting
            filteredReports.sort((a, b) => {
                switch(sortFilter) {
                    case 'date_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'priority_desc':
                        const priorityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1 };
                        return (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2);
                    case 'score_desc':
                        return (b.reproducibility_score || 0) - (a.reproducibility_score || 0);
                    default: // date_desc
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });

            displayReports();
        }

        function getStatusBadge(status) {
            const badges = {
                'open': { class: 'bg-blue-100 text-blue-800 border-blue-200', emoji: 'ðŸ”µ', text: 'Open', tooltip: 'This issue is open and waiting to be addressed' },
                'in_progress': { class: 'bg-yellow-100 text-yellow-800 border-yellow-200', emoji: 'ðŸŸ¡', text: 'In Progress', tooltip: 'This issue is currently being worked on' },
                'resolved': { class: 'bg-green-100 text-green-800 border-green-200', emoji: 'ðŸŸ¢', text: 'Resolved', tooltip: 'This issue has been fixed' },
                'closed': { class: 'bg-gray-100 text-gray-800 border-gray-200', emoji: 'âš«', text: 'Closed', tooltip: 'This issue has been closed without resolution' }
            };
            const badge = badges[status] || badges['open'];
            return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${badge.class}" title="${badge.tooltip}">
                ${badge.emoji} ${badge.text}
            </span>`;
        }

        function getPriorityBadge(priority) {
            const badges = {
                'low': { class: 'bg-green-100 text-green-800', emoji: 'ðŸŸ¢', text: 'Low' },
                'medium': { class: 'bg-yellow-100 text-yellow-800', emoji: 'ðŸŸ¡', text: 'Medium' },
                'high': { class: 'bg-orange-100 text-orange-800', emoji: 'ðŸŸ ', text: 'High' },
                'critical': { class: 'bg-red-100 text-red-800', emoji: 'ðŸ”´', text: 'Critical' }
            };
            const badge = badges[priority] || badges['medium'];
            return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${badge.class}" title="${badge.text} Priority">
                ${badge.emoji} ${badge.text}
            </span>`;
        }

        function getConfidenceBadgeClass(confidence) {
            const classes = {
                'high': 'bg-green-100 text-green-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'low': 'bg-red-100 text-red-800'
            };
            return classes[confidence] || classes['medium'];
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'warning': 'bg-yellow-600',
                'info': 'bg-blue-600'
            };
            
            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center space-x-2 mb-2`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'fixed top-4 right-4 z-50 space-y-2';
            document.body.appendChild(container);
            return container;
        }

        function toggleReportDetails(reportId) {
            const reportCard = document.querySelector(`[data-report-id="${reportId}"]`);
            const detailsDiv = reportCard.querySelector('.report-details');
            const expandText = reportCard.querySelector('.expand-text');
            const expandIcon = reportCard.querySelector('.expand-icon');
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                expandText.textContent = 'Collapse';
                expandIcon.style.transform = 'rotate(180deg)';
                
                // Smooth scroll to show the expanded content
                setTimeout(() => {
                    detailsDiv.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 100);
            } else {
                detailsDiv.classList.add('hidden');
                expandText.textContent = 'Expand';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        function viewReportDetails(reportId) {
            // Expand the report details inline
            toggleReportDetails(reportId);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>